// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// USERS
model User {
  id         String   @id @default(cuid())
  externalId String   @unique
  email      String?  @unique
  createdAt  DateTime @default(now())
  lastSeenAt DateTime @updatedAt

  conversations  Conversation[]
  uploads        Upload[]
  events         ProgressEvent[]
  profileMemory  UserProfileMemory?

  // Soft-hide for dashboard
  hiddenMessages HiddenMessage[]

  // NEW: pinned AI replies for dashboard
  pinnedMessages PinnedMessage[]
}

// CONVERSATIONS
model Conversation {
  id           String        @id @default(cuid())
  user         User          @relation(fields: [userId], references: [id])
  userId       String
  startedAt    DateTime      @default(now())
  endedAt      DateTime?
  source       String        @default("shopify_widget")
  coachProfile CoachProfile?
  workflow     Workflow?

  messages Message[]
  uploads  Upload[]
  events   ProgressEvent[]
}

// MESSAGES
model Message {
  id             String       @id @default(cuid())
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  conversationId String
  userId         String?
  role           MessageRole
  content        String
  createdAt      DateTime     @default(now())

  events ProgressEvent[]

  // Users who have hidden this message in their dashboard
  hiddenBy HiddenMessage[]

  // NEW: users who have pinned this message in their dashboard
  pinnedBy PinnedMessage[]
}

// UPLOADS
model Upload {
  id             String        @id @default(cuid())
  user           User          @relation(fields: [userId], references: [id])
  userId         String
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  conversationId String?
  url            String
  type           String
  workflow       Workflow?
  createdAt      DateTime      @default(now())
}

// PROGRESS EVENTS
model ProgressEvent {
  id             String        @id @default(cuid())
  user           User          @relation(fields: [userId], references: [id])
  userId         String
  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  conversationId String?
  message        Message?      @relation(fields: [messageId], references: [id])
  messageId      String?
  type           ProgressType
  payload        Json
  createdAt      DateTime      @default(now())
}

// USER PROFILE MEMORY
model UserProfileMemory {
  id             String   @id @default(cuid())
  user           User     @relation(fields: [userId], references: [id])
  userId         String   @unique
  goals          String?
  trainingLevel  String?
  injuries       String?
  preferredCoach String?
  data           Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// HIDDEN MESSAGES (per-user soft delete for dashboard)
model HiddenMessage {
  id        String   @id @default(cuid())

  user      User     @relation(fields: [userId], references: [id])
  userId    String

  message   Message  @relation(fields: [messageId], references: [id])
  messageId String

  createdAt DateTime @default(now())

  @@unique([userId, messageId])
}

// NEW: PINNED MESSAGES (per-user pin for dashboard)
model PinnedMessage {
  id        String   @id @default(cuid())

  user      User     @relation(fields: [userId], references: [id])
  userId    String

  message   Message  @relation(fields: [messageId], references: [id])
  messageId String

  createdAt DateTime @default(now())

  @@unique([userId, messageId])
}

// ENUMS
enum MessageRole {
  user
  assistant
}

enum Workflow {
  food_scan
  body_scan
  fitness_plan
}

enum ProgressType {
  meal_log
  body_scan
  workout_plan
  insight
}

enum CoachProfile {
  strength
  hypertrophy
  mobility
  fat_loss
}
